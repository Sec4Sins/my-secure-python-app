name: Simple CI/CD with Security Scanning

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Add permissions for security scanning
permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install Flask pytest pytest-flask
    
    - name: Run tests
      run: pytest -v

  security-scan:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Semgrep
      run: |
        pip install semgrep
        echo "=== RUNNING SEMGREP SECURITY SCAN ==="
        semgrep --config=auto --verbose . || true
        echo ""
        echo "=== GENERATING REPORTS ==="
        semgrep --config=auto --json --output=semgrep-results.json . || true
        semgrep --config=auto --sarif --output=semgrep.sarif . || true
        echo ""
        echo "=== SECURITY FINDINGS SUMMARY ==="
        if [ -f semgrep-results.json ]; then
          echo "JSON report generated successfully"
          cat semgrep-results.json | head -50
        else
          echo "No JSON report found"
        fi
    
    - name: Upload SARIF to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: semgrep.sarif
      if: always() && hashFiles('semgrep.sarif') != ''
    
    - name: Upload security results
      uses: actions/upload-artifact@v4
      with:
        name: security-results
        path: |
          semgrep-results.json
          semgrep.sarif
      if: always()

  dependency-scan:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install and scan dependencies
      run: |
        pip install safety Flask pytest
        echo "=== RUNNING DEPENDENCY VULNERABILITY SCAN ==="
        
        # Method 1: Try new Safety syntax
        safety check --format json > safety-report.json 2>&1 || echo "Method 1 failed, trying alternative"
        
        # Method 2: Try older Safety syntax if method 1 fails
        if [ ! -s safety-report.json ]; then
          safety check --json > safety-report.json 2>&1 || echo "Method 2 failed, trying basic scan"
        fi
        
        # Method 3: Basic safety check with text output
        if [ ! -s safety-report.json ]; then
          echo "=== BASIC SAFETY CHECK ===" > safety-report.txt
          safety check >> safety-report.txt 2>&1 || echo "All methods failed, but continuing..."
        fi
        
        echo "=== DEPENDENCY SCAN RESULTS ==="
        if [ -f safety-report.json ] && [ -s safety-report.json ]; then
          echo "JSON report found:"
          cat safety-report.json
        elif [ -f safety-report.txt ]; then
          echo "Text report found:"
          cat safety-report.txt
        else
          echo "No dependency vulnerabilities found or safety tool unavailable"
        fi
    
    - name: Upload dependency results
      uses: actions/upload-artifact@v4
      with:
        name: dependency-scan-results
        path: |
          safety-report.json
          safety-report.txt
      if: always()

  build:
    runs-on: ubuntu-latest
    needs: [test, security-scan, dependency-scan]
    if: always()
    steps:
    - uses: actions/checkout@v4
    
    - name: Build application
      run: |
        echo "=== BUILDING APPLICATION ==="
        mkdir -p dist
        cp *.py dist/
        echo "Flask>=2.0.0" > dist/requirements.txt
        echo "Build completed successfully!"
        ls -la dist/
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: dist/